# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile API/syntax version. Don't touch unless you know what you're doing!
VAGRANTFILE_API_VERSION = "2"

require 'yaml'
settings = YAML.load_file 'conf/settings_secured.yml'

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

    config.vm.box = 'azure'
    config.vm.provider :azure do |azure|

      azure.subscription_id = settings['subscription_id']

      azure.mgmt_certificate = settings['mgmt_certificate']
      azure.mgmt_endpoint = 'https://management.core.windows.net'
      azure.ssh_private_key_file = settings['ssh_private_key_file']
      azure.ssh_certificate_file = settings['ssh_certificate_file']

      azure.cloud_service_name = settings['cloud_service_name'] # optional. A new one will be generated if not provided.
      azure.storage_acct_name = settings['storage_acct_name'] # optional. A new one will be generated if not provided.
      azure.deployment_name = settings['deployment_name'] # defaults to cloud_service_name

      azure.vm_image = settings['vm_image']
      azure.vm_size = settings['vm_size']
      azure.vm_user = settings['vm_user'] # defaults to 'vagrant' if not provided
      azure.vm_password = settings['vm_password'] # min 8 characters. should contain a lower case letter, an uppercase letter, a number and a special character

      azure.vm_name = settings['vm_name'] #MUST BE LOWERCASE! https://github.com/MSOpenTech/vagrant-azure/issues/11 max 15 characters. contains letters, number and hyphens. can start with letters and can end with letters and numbers
      azure.vm_location = settings['vm_location'] # e.g., West US

      # Provide the following values if creating a *Nix VM
      azure.ssh_port = settings['ssh_port']

      # Provide the following values if creating a Windows VM
      #azure.winrm_transport = [ 'http', 'https' ] # this will open up winrm ports on both http (5985) and http (5986) ports
      #azure.winrm_https_port = 'A VALID PUBLIC PORT' # customize the winrm https port, instead of 5986
      #azure.winrm_http_port = 'A VALID PUBLIC PORT' # customize the winrm http port, insted of 5985

      azure.tcp_endpoints = settings['tcp_endpoints'] # opens the Remote Desktop internal port that listens on public port 53389. Without this, you cannot RDP to a Windows VM.
   end

  config.ssh.username = settings['vm_user'] # the one used to create the VM
  config.ssh.password = settings['vm_password'] # the one used to create the VM
  config.ssh.private_key_path = settings['ssh_rsa_private_key']

  config.vm.host_name = "vagrant"

  #web document root
  config.vm.synced_folder "../", "/vagrant/workspace"

  #bash scripts
  config.vm.provision :shell, :path => "bootstrap.sh"

  #puppet config
  config.vm.provision "puppet" do |puppet|
    puppet.module_path = "puppet/modules"
    puppet.manifests_path = "puppet/manifests"
    puppet.manifest_file = "init.pp"
    puppet.options = "--environment prod" 
    #puppet.options = "--verbose --debug"
  end
end
